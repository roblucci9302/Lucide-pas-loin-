name: Integration Tests

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test-sqlite:
    name: SQLite Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Rebuild native modules
        run: npm rebuild better-sqlite3

      - name: Run SQLite integration tests
        run: npm run test:integration:sqlite

  test-databases:
    name: PostgreSQL & MySQL Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: lucidi_test
          POSTGRES_PASSWORD: lucidi_test_password
          POSTGRES_DB: lucidi_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root_password
          MYSQL_DATABASE: lucidi_test
          MYSQL_USER: lucidi_test
          MYSQL_PASSWORD: lucidi_test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Install database drivers
        run: npm install --no-save pg mysql2 uuid

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U lucidi_test; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Wait for MySQL
        run: |
          until mysqladmin ping -h localhost -P 3306 -u lucidi_test -plucidi_test_password --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Initialize PostgreSQL schema
        env:
          PGPASSWORD: lucidi_test_password
        run: |
          psql -h localhost -U lucidi_test -d lucidi_test -f docker/postgres/init.sql
          psql -h localhost -U lucidi_test -d lucidi_test -f docker/postgres/test-data.sql

      - name: Initialize MySQL schema
        run: |
          mysql -h localhost -P 3306 -u lucidi_test -plucidi_test_password lucidi_test < docker/mysql/init.sql
          mysql -h localhost -P 3306 -u lucidi_test -plucidi_test_password lucidi_test < docker/mysql/test-data.sql

      - name: Run PostgreSQL integration tests
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DATABASE: lucidi_test
          POSTGRES_USER: lucidi_test
          POSTGRES_PASSWORD: lucidi_test_password
        run: npm run test:integration:postgres

      - name: Run MySQL integration tests
        env:
          MYSQL_HOST: localhost
          MYSQL_PORT: 3306
          MYSQL_DATABASE: lucidi_test
          MYSQL_USER: lucidi_test
          MYSQL_PASSWORD: lucidi_test_password
        run: npm run test:integration:mysql

  test-dependencies:
    name: Dependency & Status Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Check dependencies
        run: npm run deps:check || true

      - name: Check database status
        run: npm run deps:status || true

  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs: [test-sqlite, test-databases, test-dependencies]
    if: always()

    steps:
      - name: Generate report
        run: |
          echo "## Integration Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results:" >> $GITHUB_STEP_SUMMARY
          echo "- SQLite Tests: ${{ needs.test-sqlite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Database Tests (PostgreSQL & MySQL): ${{ needs.test-databases.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Dependency Checks: ${{ needs.test-dependencies.result }}" >> $GITHUB_STEP_SUMMARY
